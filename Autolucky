-- attemptCollectTargetSequence (Chỉ snapshot từ Backpack)
-- Yêu cầu: các helper snapshotPlayerNumbers, compareInventorySnapshots, detectPreferredNumberIncrease,
-- safeMoveToHRP, enableNoclipForCharacter tồn tại trong script hiện tại.

local function snapshotBackpack(player)
    local snap = {byName = {}, total = 0}
    if not player then return snap end

    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return snap end

    for _, v in ipairs(backpack:GetChildren()) do
        local name = tostring(v.Name or "<?>")
        snap.byName[name] = (snap.byName[name] or 0) + 1
        snap.total = snap.total + 1
    end

    return snap
end

local function attemptCollectTargetSequence(targetData)
    -- targetData: {root, part, origCFrame}
    if not targetData or not targetData.part then return false, "no_part" end
    local targetPart = targetData.part
    if not lp or not lp.Character then return false, "no_char" end
    local hrp = lp.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false, "no_hrp" end

    -- ensure noclip while we move
    if lp.Character then enableNoclipForCharacter(lp.Character) end

    -- snapshots BEFORE (numbers + backpack only)
    local beforeNums = snapshotPlayerNumbers(lp)
    local beforeInv  = snapshotBackpack(lp)

    -- touched guard (accept touches only after we moved there)
    local touchedAt = 0
    local conn
    conn = targetPart.Touched:Connect(function(hit)
        if not hit then return end
        if not lp.Character then return end
        if hit:IsDescendantOf(lp.Character) then
            touchedAt = tick()
        end
    end)

    -- movement sequence
    local startTick = tick()
    local attempts = 0
    local succeeded = false
    local detectDetails = nil

    -- move near player then to target
    local playerHRP = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if playerHRP then
        local nearPlayerCF = playerHRP.CFrame * CFrame.new(0,0,1.6)
        safeMoveToHRP(hrp, nearPlayerCF)
        task.wait(0.08)
    end

    local approachCF = targetPart.CFrame + Vector3.new(0,1.2,0)
    safeMoveToHRP(hrp, approachCF)
    task.wait(0.06)
    local moveStart = tick()

    while attempts < MAX_ATTEMPTS_PER_TARGET and (tick() - startTick) < MAX_SECONDS_PER_TARGET do
        if not lp or not lp.Character then break end
        hrp = lp.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then break end

        if (hrp.Position - approachCF.Position).Magnitude > 3.6 then
            safeMoveToHRP(hrp, approachCF)
            task.wait(0.06)
        end

        -- aggressive touch
        pcall(function()
            firetouchinterest(hrp, targetPart, 0)
            task.wait(0.035)
            firetouchinterest(hrp, targetPart, 1)
        end)

        attempts = attempts + 1

        -- short detection window
        local deadline = tick() + AFTER_TOUCH_SETTLE
        while tick() < deadline do
            -- 1) touched after move
            if touchedAt >= moveStart then
                -- re-snapshot backpack and numbers
                local afterNums = snapshotPlayerNumbers(lp)
                local afterInv  = snapshotBackpack(lp)

                -- numeric check (leaderstats)
                local numOk, numDetails = detectPreferredNumberIncrease(beforeNums, afterNums)
                -- backpack only check
                local invOk, invDiffs, invDelta = compareInventorySnapshots(beforeInv, afterInv)

                if numOk then
                    succeeded = true
                    detectDetails = ("num_inc %s +%s"):format(tostring(numDetails.name or "?"), tostring(numDetails.delta or "?"))
                    break
                elseif invOk then
                    local infoParts = {}
                    for _, d in ipairs(invDiffs) do
                        table.insert(infoParts, ("%s +%d"):format(d.name, d.delta))
                    end
                    detectDetails = ("backpack_inc total+%d (%s)"):format(invDelta, table.concat(infoParts, ","))
                    succeeded = true
                    break
                else
                    -- accept local touch even if backpack didn't change (some games don't move items into backpack immediately)
                    succeeded = true
                    detectDetails = ("touched_local attempts=%d"):format(attempts)
                    break
                end
            end

            -- 2) numeric increase without touch
            local afterNums2 = snapshotPlayerNumbers(lp)
            local numOk2, numDetails2 = detectPreferredNumberIncrease(beforeNums, afterNums2)
            if numOk2 then
                succeeded = true
                detectDetails = ("num_inc %s +%s"):format(tostring(numDetails2.name or "?"), tostring(numDetails2.delta or "?"))
                break
            end

            -- 3) backpack increase without touch
            local afterInv2 = snapshotBackpack(lp)
            local invOk2, invDiffs2, invDelta2 = compareInventorySnapshots(beforeInv, afterInv2)
            if invOk2 then
                local infoParts = {}
                for _, d in ipairs(invDiffs2) do
                    table.insert(infoParts, ("%s +%d"):format(d.name, d.delta))
                end
                detectDetails = ("backpack_inc total+%d (%s)"):format(invDelta2, table.concat(infoParts,","))
                succeeded = true
                break
            end

            -- 4) moved away heuristic
            if (hrp.Position - targetPart.Position).Magnitude > 16 then
                succeeded = true
                detectDetails = ("moved_away dist=%.1f"):format((hrp.Position - targetPart.Position).Magnitude)
                break
            end

            task.wait(0.03)
        end

        if succeeded then break end
        task.wait(0.06)
    end

    -- move back to original obby position if known
    if targetData.origCFrame then
        pcall(function() safeMoveToHRP(hrp, targetData.origCFrame + Vector3.new(0,1.2,0)) end)
        task.wait(0.12)
    end

    -- cleanup
    if conn and conn.Connected then pcall(function() conn:Disconnect() end) end

    -- final backpack/number re-check before fail
    if not succeeded then
        local afterNumsFinal = snapshotPlayerNumbers(lp)
        local afterInvFinal  = snapshotBackpack(lp)
        local numOkF, numDetF = detectPreferredNumberIncrease(beforeNums, afterNumsFinal)
        local invOkF, invDiffsF, invDeltaF = compareInventorySnapshots(beforeInv, afterInvFinal)
        if numOkF then
            return true, ("final_num_inc %s +%s"):format(tostring(numDetF.name or "?"), tostring(numDetF.delta or "?"))
        elseif invOkF then
            local infoParts = {}
            for _, d in ipairs(invDiffsF) do table.insert(infoParts, ("%s +%d"):format(d.name, d.delta)) end
            return true, ("final_backpack_inc total+%d (%s)"):format(invDeltaF, table.concat(infoParts, ","))
        else
            return false, ("failed attempts=%d elapsed=%.1fs"):format(attempts, tick() - startTick)
        end
    end

    return true, tostring(detectDetails or "success")
end
