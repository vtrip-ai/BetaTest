-- Chống dupe GUI và Check Debug
if MT_LOADED and not _G.MT_DEBUG == true then
    return
end
pcall(function() getgenv().MT_LOADED = true end)

-- Đợi game load hoàn tất
if not game:IsLoaded() then 
    game.Loaded:Wait() 
end

-- Khai báo dịch vụ
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local lp = Players.LocalPlayer

-- Hàm missing xử lý fallback dữ liệu
function missing(t, f, fallback)
    if type(f) == t then return f end
    return fallback
end

-- Cấu hình Teleport (Dùng queue_on_teleport để tự chạy lại sau khi hop)
local TeleportCheck = false
local queueteleport = missing("function", (syn and syn.queue_on_teleport) or queue_on_teleport, function() end)

lp.OnTeleport:Connect(function(State)
    if not TeleportCheck and queueteleport then
        TeleportCheck = true
        queueteleport("loadstring(game:HttpGet('https://raw.githubusercontent.com/vtrip-ai/BetaTest/refs/heads/main/Autolucky'))()")
    end
end)

-- GUI Mobile (Draggable)
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
local MainFrame = Instance.new("Frame", ScreenGui)
local ToggleBtn = Instance.new("TextButton", MainFrame)

MainFrame.Size = UDim2.new(0, 140, 0, 45)
MainFrame.Position = UDim2.new(0.5, -70, 0.1, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.Active = true
MainFrame.Draggable = true

ToggleBtn.Size = UDim2.new(1, -10, 1, -10)
ToggleBtn.Position = UDim2.new(0, 5, 0, 5)
ToggleBtn.Text = "AUTO: OFF"
ToggleBtn.TextColor3 = Color3.new(1, 1, 1)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)

local Toggled = false
local ObbyPaths = {
    "MoneyObby3End",
    "MoneyObby2End",
    "MoneyObby1End"
}

-- Hàm Server Hop
local function ServerHop()
    local success, result = pcall(function()
        local servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"))
        for _, s in pairs(servers.data) do
            if s.playing < s.maxPlayers and s.id ~= game.JobId then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id)
                return true
            end
        end
    end)
    if not success or not result then
        task.wait(2)
        ServerHop() -- Re-hop nếu lỗi
    end
end

-- Logic Main Loop
ToggleBtn.MouseButton1Click:Connect(function()
    Toggled = not Toggled
    ToggleBtn.Text = Toggled and "AUTO: ON" or "AUTO: OFF"
    ToggleBtn.BackgroundColor3 = Toggled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)

    if Toggled then
        task.spawn(function()
            -- Check path tồn tại mỗi lần bật
            local SharedFolder = workspace:FindFirstChild("MoneyMap_SharedInstances")
            if not SharedFolder then 
                warn("Path không tồn tại!") 
                return 
            end

            for _, name in ipairs(ObbyPaths) do
                if not Toggled then break end
                local target = SharedFolder:FindFirstChild(name)
                
                if target and lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
                    -- LoopGoto / Teleport
                    lp.Character.HumanoidRootPart.CFrame = target.CFrame
                    task.wait(2)
                    
                    -- Fire TouchTransmitler 3 lần
                    for i = 1, 3 do
                        firetouchinterest(lp.Character.HumanoidRootPart, target, 0)
                        task.wait(0.1)
                        firetouchinterest(lp.Character.HumanoidRootPart, target, 1)
                    end
                end
            end

            -- Sau khi xong 3 cái hoặc nếu lỗi/full thì hop
            if Toggled then
                ServerHop()
            end
        end)
    end
end)
