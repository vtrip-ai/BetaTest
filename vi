-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

-- Local Player
local LocalPlayer = Players.LocalPlayer

-- Tạo Window
local Window = Rayfield:CreateWindow({
   Name = "Trap ESP & Auto Money",
   LoadingTitle = "Loading Script",
   LoadingSubtitle = "by Script",
   ConfigurationSaving = {
      Enabled = false,
      FolderName = nil,
      FileName = "TrapESP"
   },
   Discord = {
      Enabled = false,
      Invite = "noinvite",
      RememberJoins = true
   },
   KeySystem = false
})

-- Tạo Tabs
local TrapTab = Window:CreateTab("Trap ESP", 4483362458)
local FarmTab = Window:CreateTab("Auto Farm", 4483362458)

-- Biến lưu trạng thái
local showTrapsEnabled = false
local highlightedTraps = {}
local avatarGuis = {}
local avatarSize = 100
local autoMoneyEnabled = false
local autoMoneyConnection = nil
local originalWinPadPosition = nil
local originalWinPadCanCollide = nil

-- Hàm lấy UserID từ username
local function getUserIdFromUsername(username)
   local success, userId = pcall(function()
      return Players:GetUserIdFromNameAsync(username)
   end)
   if success then
      return userId
   else
      return nil
   end
end

-- Hàm tạo BillboardGui với avatar (size cố định, không scale)
local function createAvatarGui(hitbox, username)
   -- Xóa GUI cũ nếu có
   if avatarGuis[hitbox] then
      avatarGuis[hitbox]:Destroy()
      avatarGuis[hitbox] = nil
   end
   
   -- Tạo BillboardGui
   local billboardGui = Instance.new("BillboardGui")
   billboardGui.Name = "TrapAvatarESP"
   billboardGui.Adornee = hitbox
   billboardGui.Size = UDim2.new(0, avatarSize, 0, avatarSize)
   billboardGui.StudsOffset = Vector3.new(0, 5, 0)
   billboardGui.AlwaysOnTop = true
   billboardGui.MaxDistance = math.huge
   
   -- QUAN TRỌNG: Tắt các thuộc tính scale theo khoảng cách
   billboardGui.SizeOffset = Vector2.new(0, 0)
   billboardGui.StudsOffsetWorldSpace = Vector3.new(0, 0, 0)
   
   billboardGui.Parent = hitbox
   
   -- Tạo Frame container
   local frame = Instance.new("Frame")
   frame.Size = UDim2.new(1, 0, 1, 0)
   frame.BackgroundTransparency = 0.3
   frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
   frame.BorderSizePixel = 2
   frame.BorderColor3 = Color3.fromRGB(255, 0, 0)
   frame.Parent = billboardGui
   
   -- Tạo UICorner cho frame
   local corner = Instance.new("UICorner")
   corner.CornerRadius = UDim.new(0.2, 0)
   corner.Parent = frame
   
   -- Tạo ImageLabel cho avatar
   local avatarImage = Instance.new("ImageLabel")
   avatarImage.Size = UDim2.new(0.8, 0, 0.7, 0)
   avatarImage.Position = UDim2.new(0.1, 0, 0.05, 0)
   avatarImage.BackgroundTransparency = 1
   avatarImage.ScaleType = Enum.ScaleType.Fit
   avatarImage.Parent = frame
   
   -- Tạo UICorner cho avatar
   local avatarCorner = Instance.new("UICorner")
   avatarCorner.CornerRadius = UDim.new(0.5, 0)
   avatarCorner.Parent = avatarImage
   
   -- Tạo TextLabel cho username
   local nameLabel = Instance.new("TextLabel")
   nameLabel.Size = UDim2.new(1, 0, 0.2, 0)
   nameLabel.Position = UDim2.new(0, 0, 0.78, 0)
   nameLabel.BackgroundTransparency = 1
   nameLabel.Text = username
   nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
   nameLabel.TextScaled = true
   nameLabel.Font = Enum.Font.GothamBold
   nameLabel.TextStrokeTransparency = 0.5
   nameLabel.Parent = frame
   
   -- Thêm UITextSizeConstraint để text không quá nhỏ
   local textConstraint = Instance.new("UITextSizeConstraint")
   textConstraint.MinTextSize = 8
   textConstraint.MaxTextSize = 14
   textConstraint.Parent = nameLabel
   
   -- Lấy avatar từ UserID
   local userId = getUserIdFromUsername(username)
   if userId then
      local avatarUrl = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. userId .. "&width=150&height=150&format=png"
      avatarImage.Image = avatarUrl
   else
      avatarImage.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
   end
   
   -- Lưu reference
   avatarGuis[hitbox] = billboardGui
end

-- Hàm hiển thị trap
local function showTrap(hitbox, username)
   -- Highlight hitbox
   hitbox.Transparency = 0.5
   hitbox.Color = Color3.fromRGB(255, 0, 0)
   hitbox.Material = Enum.Material.Neon
   
   -- Tạo avatar GUI
   createAvatarGui(hitbox, username)
   
   highlightedTraps[hitbox] = true
end

-- Hàm hiển thị tất cả traps
local function showAllTraps()
   local trapsFolder = Workspace:WaitForChild("Game"):WaitForChild("Traps")
   
   for _, trap in pairs(trapsFolder:GetChildren()) do
      if trap:IsA("Model") or trap:IsA("Folder") then
         local hitbox = trap:FindFirstChild("Hitbox")
         if hitbox and hitbox:IsA("BasePart") then
            if not highlightedTraps[hitbox] then
               local username = trap.Name
               showTrap(hitbox, username)
            end
         end
      end
   end
end

-- Hàm ẩn tất cả traps
local function hideAllTraps()
   local trapsFolder = Workspace:WaitForChild("Game"):WaitForChild("Traps")
   
   for _, trap in pairs(trapsFolder:GetChildren()) do
      if trap:IsA("Model") or trap:IsA("Folder") then
         local hitbox = trap:FindFirstChild("Hitbox")
         if hitbox and hitbox:IsA("BasePart") then
            hitbox.Transparency = 1
            
            if avatarGuis[hitbox] then
               avatarGuis[hitbox]:Destroy()
               avatarGuis[hitbox] = nil
            end
            
            highlightedTraps[hitbox] = nil
         end
      end
   end
end

-- Hàm theo dõi trap mới
local function monitorNewTraps()
   local trapsFolder = Workspace:WaitForChild("Game"):WaitForChild("Traps")
   
   trapsFolder.ChildAdded:Connect(function(trap)
      if showTrapsEnabled then
         task.wait(0.1)
         if trap:IsA("Model") or trap:IsA("Folder") then
            local hitbox = trap:FindFirstChild("Hitbox")
            if hitbox and hitbox:IsA("BasePart") then
               local username = trap.Name
               showTrap(hitbox, username)
            end
         end
      end
   end)
   
   trapsFolder.ChildRemoved:Connect(function(trap)
      if trap:IsA("Model") or trap:IsA("Folder") then
         local hitbox = trap:FindFirstChild("Hitbox")
         if hitbox and avatarGuis[hitbox] then
            avatarGuis[hitbox]:Destroy()
            avatarGuis[hitbox] = nil
            highlightedTraps[hitbox] = nil
         end
      end
   end)
end

-- Hàm Auto Money
local function startAutoMoney()
   local success, winPad = pcall(function()
      return Workspace:WaitForChild("Lobby"):WaitForChild("Obby"):WaitForChild("Platforms"):WaitForChild("WinPad")
   end)
   
   if not success or not winPad then
      Rayfield:Notify({
         Title = "Error",
         Content = "Cannot find WinPad!",
         Duration = 3,
         Image = 4483362458,
      })
      return
   end
   
   -- Lưu vị trí và trạng thái collision gốc
   if not originalWinPadPosition then
      originalWinPadPosition = winPad.CFrame
   end
   if originalWinPadCanCollide == nil then
      originalWinPadCanCollide = winPad.CanCollide
   end
   
   -- Tắt collision để không đẩy player
   winPad.CanCollide = false
   
   autoMoneyConnection = RunService.Heartbeat:Connect(function()
      if autoMoneyEnabled then
         local character = LocalPlayer.Character
         if character and character:FindFirstChild("HumanoidRootPart") then
            local hrp = character.HumanoidRootPart
            -- Dịch chuyển WinPad đến vị trí player (dưới chân)
            winPad.CFrame = hrp.CFrame + Vector3.new(0, -3, 0)
            
            -- Đảm bảo CanCollide luôn tắt
            if winPad.CanCollide then
               winPad.CanCollide = false
            end
         end
      end
   end)
end

-- Hàm dừng Auto Money
local function stopAutoMoney()
   if autoMoneyConnection then
      autoMoneyConnection:Disconnect()
      autoMoneyConnection = nil
   end
   
   -- Di chuyển WinPad về vị trí xa và khôi phục collision
   local success, winPad = pcall(function()
      return Workspace:WaitForChild("Lobby"):WaitForChild("Obby"):WaitForChild("Platforms"):WaitForChild("WinPad")
   end)
   
   if success and winPad then
      -- Di chuyển đến vị trí xa (10000 studs trên trời)
      winPad.CFrame = CFrame.new(0, 10000, 0)
      
      -- Khôi phục collision về trạng thái ban đầu
      if originalWinPadCanCollide ~= nil then
         winPad.CanCollide = originalWinPadCanCollide
      end
   end
end

-- ===== TRAP ESP TAB =====

-- Toggle Show All Traps
local TrapToggle = TrapTab:CreateToggle({
   Name = "Show All Traps",
   CurrentValue = false,
   Flag = "ShowTrapsToggle",
   Callback = function(Value)
      showTrapsEnabled = Value
      
      if Value then
         showAllTraps()
      else
         hideAllTraps()
      end
   end,
})

-- Slider kích thước avatar
local SizeSlider = TrapTab:CreateSlider({
   Name = "Avatar Size",
   Range = {10, 200},
   Increment = 5,
   CurrentValue = 100,
   Flag = "AvatarSizeSlider",
   Callback = function(Value)
      avatarSize = Value
      -- Cập nhật kích thước tất cả avatar
      for hitbox, gui in pairs(avatarGuis) do
         if gui and gui.Parent then
            gui.Size = UDim2.new(0, Value, 0, Value)
         end
      end
   end,
})

-- ===== AUTO FARM TAB =====

-- Toggle Auto Money
local MoneyToggle = FarmTab:CreateToggle({
   Name = "Auto Money",
   CurrentValue = false,
   Flag = "AutoMoneyToggle",
   Callback = function(Value)
      autoMoneyEnabled = Value
      
      if Value then
         startAutoMoney()
         Rayfield:Notify({
            Title = "Auto Money",
            Content = "Auto Money Enabled! (NoClip)",
            Duration = 2,
            Image = 4483362458,
         })
      else
         stopAutoMoney()
         Rayfield:Notify({
            Title = "Auto Money",
            Content = "Auto Money Disabled!",
            Duration = 2,
            Image = 4483362458,
         })
      end
   end,
})

-- Bắt đầu theo dõi trap mới
monitorNewTraps()

-- Thông báo load thành công
Rayfield:Notify({
   Title = "Script Loaded",
   Content = "All features ready!",
   Duration = 3,
   Image = 4483362458,
})
